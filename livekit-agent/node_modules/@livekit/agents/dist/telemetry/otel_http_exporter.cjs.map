{"version":3,"sources":["../../src/telemetry/otel_http_exporter.ts"],"sourcesContent":["// SPDX-FileCopyrightText: 2025 LiveKit, Inc.\n//\n// SPDX-License-Identifier: Apache-2.0\n\n/**\n * OTLP HTTP JSON Log Exporter for LiveKit Cloud\n *\n * This module provides a custom OTLP log exporter that uses HTTP with JSON format\n * instead of the default protobuf format.\n */\nimport { SeverityNumber } from '@opentelemetry/api-logs';\nimport { AccessToken } from 'livekit-server-sdk';\n\nexport interface SimpleLogRecord {\n  /** Log message body */\n  body: string;\n  /** Timestamp in milliseconds since epoch */\n  timestampMs: number;\n  /** Log attributes */\n  attributes: Record<string, unknown>;\n  /** Severity number (default: UNSPECIFIED) */\n  severityNumber?: SeverityNumber;\n  /** Severity text (default: 'unspecified') */\n  severityText?: string;\n}\n\nexport interface SimpleOTLPHttpLogExporterConfig {\n  /** LiveKit Cloud hostname */\n  cloudHostname: string;\n  /** Resource attributes (e.g., room_id, job_id) */\n  resourceAttributes: Record<string, string>;\n  /** Scope name for the logger */\n  scopeName: string;\n  /** Scope attributes */\n  scopeAttributes?: Record<string, string>;\n}\n\n/**\n * Simple OTLP HTTP Log Exporter for direct log export\n *\n * This is a simplified exporter that doesn't require the full SDK infrastructure.\n * Use this when you need to send logs directly without LoggerProvider.\n *\n * @example\n * ```typescript\n * const exporter = new SimpleOTLPHttpLogExporter({\n *   cloudHostname: 'cloud.livekit.io',\n *   resourceAttributes: { room_id: 'xxx', job_id: 'yyy' },\n *   scopeName: 'chat_history',\n * });\n *\n * await exporter.export([\n *   { body: 'Hello', timestampMs: Date.now(), attributes: { test: true } },\n * ]);\n * ```\n */\nexport class SimpleOTLPHttpLogExporter {\n  private readonly config: SimpleOTLPHttpLogExporterConfig;\n  private jwt: string | null = null;\n\n  constructor(config: SimpleOTLPHttpLogExporterConfig) {\n    this.config = config;\n  }\n\n  /**\n   * Export simple log records\n   */\n  async export(records: SimpleLogRecord[]): Promise<void> {\n    if (records.length === 0) return;\n\n    await this.ensureJwt();\n\n    const endpoint = `https://${this.config.cloudHostname}/observability/logs/otlp/v0`;\n    const payload = this.buildPayload(records);\n\n    const response = await fetch(endpoint, {\n      method: 'POST',\n      headers: {\n        Authorization: `Bearer ${this.jwt}`,\n        'Content-Type': 'application/json',\n      },\n      body: JSON.stringify(payload),\n    });\n\n    if (!response.ok) {\n      const text = await response.text();\n      throw new Error(\n        `OTLP log export failed: ${response.status} ${response.statusText} - ${text}`,\n      );\n    }\n  }\n\n  private async ensureJwt(): Promise<void> {\n    if (this.jwt) return;\n\n    const apiKey = process.env.LIVEKIT_API_KEY;\n    const apiSecret = process.env.LIVEKIT_API_SECRET;\n\n    if (!apiKey || !apiSecret) {\n      throw new Error('LIVEKIT_API_KEY and LIVEKIT_API_SECRET must be set');\n    }\n\n    const token = new AccessToken(apiKey, apiSecret, { ttl: '6h' });\n    token.addObservabilityGrant({ write: true });\n    this.jwt = await token.toJwt();\n  }\n\n  private buildPayload(records: SimpleLogRecord[]): object {\n    const resourceAttrs = Object.entries(this.config.resourceAttributes).map(([key, value]) => ({\n      key,\n      value: { stringValue: value },\n    }));\n\n    if (!this.config.resourceAttributes['service.name']) {\n      resourceAttrs.push({ key: 'service.name', value: { stringValue: 'livekit-agents' } });\n    }\n\n    const scopeAttrs = this.config.scopeAttributes\n      ? Object.entries(this.config.scopeAttributes).map(([key, value]) => ({\n          key,\n          value: { stringValue: value },\n        }))\n      : [];\n\n    const logRecords = records.map((record) => {\n      // Ensure timestampMs is a valid number, fallback to current time if NaN/undefined\n      const timestampMs = Number.isFinite(record.timestampMs) ? record.timestampMs : Date.now();\n      return {\n        timeUnixNano: String(BigInt(Math.floor(timestampMs * 1_000_000))),\n        observedTimeUnixNano: String(BigInt(Date.now()) * BigInt(1_000_000)),\n        severityNumber: record.severityNumber ?? SeverityNumber.UNSPECIFIED,\n        severityText: record.severityText ?? 'unspecified',\n        body: { stringValue: record.body },\n        attributes: this.convertAttributes(record.attributes),\n        traceId: '',\n        spanId: '',\n      };\n    });\n\n    return {\n      resourceLogs: [\n        {\n          resource: { attributes: resourceAttrs },\n          scopeLogs: [\n            {\n              scope: {\n                name: this.config.scopeName,\n                attributes: scopeAttrs,\n              },\n              logRecords,\n            },\n          ],\n        },\n      ],\n    };\n  }\n\n  private convertAttributes(\n    attrs: Record<string, unknown>,\n  ): Array<{ key: string; value: unknown }> {\n    return Object.entries(attrs).map(([key, value]) => ({\n      key,\n      value: this.convertValue(value),\n    }));\n  }\n\n  private convertValue(value: unknown): unknown {\n    if (value === null || value === undefined) {\n      return { stringValue: '' };\n    }\n    if (typeof value === 'string') {\n      return { stringValue: value };\n    }\n    if (typeof value === 'number') {\n      return Number.isInteger(value) ? { intValue: String(value) } : { doubleValue: value };\n    }\n    if (typeof value === 'boolean') {\n      return { boolValue: value };\n    }\n    if (Array.isArray(value)) {\n      return { arrayValue: { values: value.map((v) => this.convertValue(v)) } };\n    }\n    if (typeof value === 'object') {\n      return {\n        kvlistValue: {\n          values: Object.entries(value as Record<string, unknown>).map(([k, v]) => ({\n            key: k,\n            value: this.convertValue(v),\n          })),\n        },\n      };\n    }\n    return { stringValue: String(value) };\n  }\n}\n"],"mappings":"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","names":[]}