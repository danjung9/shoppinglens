{"version":3,"sources":["../../src/llm/fallback_adapter.test.ts"],"sourcesContent":["// SPDX-FileCopyrightText: 2024 LiveKit, Inc.\n//\n// SPDX-License-Identifier: Apache-2.0\nimport { beforeAll, describe, expect, it, vi } from 'vitest';\nimport { APIConnectionError, APIError } from '../_exceptions.js';\nimport { initializeLogger } from '../log.js';\nimport type { APIConnectOptions } from '../types.js';\nimport { delay } from '../utils.js';\nimport type { ChatContext } from './chat_context.js';\nimport { FallbackAdapter } from './fallback_adapter.js';\nimport { type ChatChunk, LLM, LLMStream } from './llm.js';\nimport type { ToolChoice, ToolContext } from './tool_context.js';\n\nclass MockLLMStream extends LLMStream {\n  public myLLM: LLM;\n\n  constructor(\n    llm: LLM,\n    opts: {\n      chatCtx: ChatContext;\n      toolCtx?: ToolContext;\n      connOptions: APIConnectOptions;\n    },\n    private shouldFail: boolean = false,\n    private failAfterChunks: number = 0,\n  ) {\n    super(llm, opts);\n    this.myLLM = llm;\n  }\n\n  protected async run(): Promise<void> {\n    if (this.shouldFail && this.failAfterChunks === 0) {\n      throw new APIError('Mock LLM failed immediately');\n    }\n\n    const chunk: ChatChunk = {\n      id: 'test-id',\n      delta: { role: 'assistant', content: 'chunk' },\n    };\n\n    for (let i = 0; i < 3; i++) {\n      if (this.shouldFail && i === this.failAfterChunks) {\n        throw new APIError('Mock LLM failed after chunks');\n      }\n      this.queue.put(chunk);\n      await delay(10);\n    }\n  }\n}\n\nclass MockLLM extends LLM {\n  shouldFail: boolean = false;\n  failAfterChunks: number = 0;\n  private _label: string;\n\n  constructor(label: string) {\n    super();\n    this._label = label;\n  }\n\n  label(): string {\n    return this._label;\n  }\n\n  chat(opts: {\n    chatCtx: ChatContext;\n    toolCtx?: ToolContext;\n    connOptions?: APIConnectOptions;\n    parallelToolCalls?: boolean;\n    toolChoice?: ToolChoice;\n    extraKwargs?: Record<string, unknown>;\n  }): LLMStream {\n    return new MockLLMStream(\n      this,\n      {\n        chatCtx: opts.chatCtx,\n        toolCtx: opts.toolCtx,\n        connOptions: opts.connOptions!,\n      },\n      this.shouldFail,\n      this.failAfterChunks,\n    );\n  }\n}\n\ndescribe('FallbackAdapter', () => {\n  beforeAll(() => {\n    initializeLogger({ pretty: false });\n    // Suppress unhandled rejections from LLMStream background tasks\n    process.on('unhandledRejection', () => {});\n  });\n\n  it('should initialize correctly', () => {\n    const llm1 = new MockLLM('llm1');\n    const adapter = new FallbackAdapter({ llms: [llm1] });\n    expect(adapter.llms).toHaveLength(1);\n    expect(adapter.llms[0]).toBe(llm1);\n  });\n\n  it('should throw if no LLMs provided', () => {\n    expect(() => new FallbackAdapter({ llms: [] })).toThrow();\n  });\n\n  it('should use primary LLM if successful', async () => {\n    const llm1 = new MockLLM('llm1');\n    const llm2 = new MockLLM('llm2');\n    const adapter = new FallbackAdapter({ llms: [llm1, llm2] });\n\n    const stream = adapter.chat({\n      chatCtx: {} as ChatContext,\n    });\n\n    const chunks: ChatChunk[] = [];\n    for await (const chunk of stream) {\n      chunks.push(chunk);\n    }\n\n    expect(chunks).toHaveLength(3);\n    // Should verify it used llm1 (we can check logs or spy, but simple success is good first step)\n  });\n\n  it('should fallback to second LLM if first fails immediately', async () => {\n    const llm1 = new MockLLM('llm1');\n    llm1.shouldFail = true;\n    const llm2 = new MockLLM('llm2');\n    const adapter = new FallbackAdapter({ llms: [llm1, llm2] });\n\n    const stream = adapter.chat({\n      chatCtx: {} as ChatContext,\n    });\n\n    const chunks: ChatChunk[] = [];\n    for await (const chunk of stream) {\n      chunks.push(chunk);\n    }\n\n    expect(chunks).toHaveLength(3);\n    expect(adapter._status[0]!.available).toBe(false);\n    expect(adapter._status[1]!.available).toBe(true);\n  });\n\n  it('should fail if all LLMs fail', async () => {\n    const llm1 = new MockLLM('llm1');\n    llm1.shouldFail = true;\n    const llm2 = new MockLLM('llm2');\n    llm2.shouldFail = true;\n    const adapter = new FallbackAdapter({ llms: [llm1, llm2] });\n\n    const stream = adapter.chat({\n      chatCtx: {} as ChatContext,\n    });\n\n    const errorPromise = new Promise<Error>((resolve) => {\n      adapter.on('error', (e) => resolve(e.error));\n    });\n\n    for await (const _ of stream) {\n      // consume\n    }\n\n    const error = await errorPromise;\n    expect(error).toBeInstanceOf(APIConnectionError);\n  });\n\n  it('should fail if chunks sent and retryOnChunkSent is false', async () => {\n    const llm1 = new MockLLM('llm1');\n    llm1.shouldFail = true;\n    llm1.failAfterChunks = 1; // Fail after 1 chunk\n    const llm2 = new MockLLM('llm2');\n    const adapter = new FallbackAdapter({\n      llms: [llm1, llm2],\n      retryOnChunkSent: false,\n    });\n\n    const stream = adapter.chat({\n      chatCtx: {} as ChatContext,\n    });\n\n    const errorPromise = new Promise<Error>((resolve) => {\n      adapter.on('error', (e) => resolve(e.error));\n    });\n\n    for await (const _ of stream) {\n      // consume\n    }\n\n    const error = await errorPromise;\n    expect(error).toBeInstanceOf(APIError);\n  });\n\n  it('should fallback if chunks sent and retryOnChunkSent is true', async () => {\n    const llm1 = new MockLLM('llm1');\n    llm1.shouldFail = true;\n    llm1.failAfterChunks = 1;\n    const llm2 = new MockLLM('llm2');\n    const adapter = new FallbackAdapter({\n      llms: [llm1, llm2],\n      retryOnChunkSent: true,\n    });\n\n    const stream = adapter.chat({\n      chatCtx: {} as ChatContext,\n    });\n\n    const chunks: ChatChunk[] = [];\n    for await (const chunk of stream) {\n      chunks.push(chunk);\n    }\n\n    // 1 chunk from failed llm1 + 3 chunks from llm2\n    expect(chunks).toHaveLength(4);\n  });\n\n  it('should emit availability changed events', async () => {\n    const llm1 = new MockLLM('llm1');\n    llm1.shouldFail = true;\n    const llm2 = new MockLLM('llm2');\n    const adapter = new FallbackAdapter({ llms: [llm1, llm2] });\n\n    const eventSpy = vi.fn();\n    (adapter as any).on('llm_availability_changed', eventSpy);\n\n    const stream = adapter.chat({\n      chatCtx: {} as ChatContext,\n    });\n\n    for await (const _ of stream) {\n      // consume\n    }\n\n    expect(eventSpy).toHaveBeenCalledWith(\n      expect.objectContaining({\n        llm: llm1,\n        available: false,\n      }),\n    );\n  });\n});\n"],"mappings":"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","names":[]}