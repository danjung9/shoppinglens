"use strict";
var __defProp = Object.defineProperty;
var __getOwnPropDesc = Object.getOwnPropertyDescriptor;
var __getOwnPropNames = Object.getOwnPropertyNames;
var __hasOwnProp = Object.prototype.hasOwnProperty;
var __export = (target, all) => {
  for (var name in all)
    __defProp(target, name, { get: all[name], enumerable: true });
};
var __copyProps = (to, from, except, desc) => {
  if (from && typeof from === "object" || typeof from === "function") {
    for (let key of __getOwnPropNames(from))
      if (!__hasOwnProp.call(to, key) && key !== except)
        __defProp(to, key, { get: () => from[key], enumerable: !(desc = __getOwnPropDesc(from, key)) || desc.enumerable });
  }
  return to;
};
var __toCommonJS = (mod) => __copyProps(__defProp({}, "__esModule", { value: true }), mod);
var pino_otel_transport_exports = {};
__export(pino_otel_transport_exports, {
  PinoCloudExporter: () => PinoCloudExporter,
  emitToOtel: () => emitToOtel,
  flushPinoLogs: () => flushPinoLogs,
  getPinoCloudExporter: () => getPinoCloudExporter,
  initPinoCloudExporter: () => initPinoCloudExporter
});
module.exports = __toCommonJS(pino_otel_transport_exports);
var import_api_logs = require("@opentelemetry/api-logs");
var import_livekit_server_sdk = require("livekit-server-sdk");
function mapPinoLevelToSeverity(pinoLevel) {
  if (pinoLevel <= 10) {
    return { severityNumber: import_api_logs.SeverityNumber.TRACE, severityText: "TRACE" };
  } else if (pinoLevel <= 20) {
    return { severityNumber: import_api_logs.SeverityNumber.DEBUG, severityText: "DEBUG" };
  } else if (pinoLevel <= 30) {
    return { severityNumber: import_api_logs.SeverityNumber.INFO, severityText: "INFO" };
  } else if (pinoLevel <= 40) {
    return { severityNumber: import_api_logs.SeverityNumber.WARN, severityText: "WARN" };
  } else if (pinoLevel <= 50) {
    return { severityNumber: import_api_logs.SeverityNumber.ERROR, severityText: "ERROR" };
  } else {
    return { severityNumber: import_api_logs.SeverityNumber.FATAL, severityText: "FATAL" };
  }
}
const EXCLUDE_FIELDS = /* @__PURE__ */ new Set(["level", "time", "msg", "pid", "hostname", "v"]);
function convertValue(value) {
  if (value === null || value === void 0) {
    return { stringValue: "" };
  }
  if (typeof value === "string") {
    return { stringValue: value };
  }
  if (typeof value === "number") {
    return Number.isInteger(value) ? { intValue: String(value) } : { doubleValue: value };
  }
  if (typeof value === "boolean") {
    return { boolValue: value };
  }
  if (typeof value === "object") {
    return { stringValue: JSON.stringify(value) };
  }
  return { stringValue: String(value) };
}
class PinoCloudExporter {
  config;
  loggerName;
  batchSize;
  flushIntervalMs;
  jwt = null;
  pendingLogs = [];
  flushTimer = null;
  constructor(config) {
    this.config = config;
    this.loggerName = config.loggerName || "livekit.agents";
    this.batchSize = config.batchSize || 100;
    this.flushIntervalMs = config.flushIntervalMs || 5e3;
  }
  emit(logObj) {
    const record = this.convertToOtlpRecord(logObj);
    this.pendingLogs.push(record);
    if (!this.flushTimer) {
      this.flushTimer = setTimeout(() => {
        this.flush().catch(console.error);
      }, this.flushIntervalMs);
    }
    if (this.pendingLogs.length >= this.batchSize) {
      this.flush().catch(console.error);
    }
  }
  convertToOtlpRecord(logObj) {
    const { severityNumber, severityText } = mapPinoLevelToSeverity(logObj.level);
    const attributes = [
      { key: "room_id", value: { stringValue: this.config.roomId } },
      { key: "job_id", value: { stringValue: this.config.jobId } },
      { key: "logger.name", value: { stringValue: this.loggerName } }
    ];
    if (logObj.pid !== void 0) {
      attributes.push({ key: "process.pid", value: { intValue: String(logObj.pid) } });
    }
    if (logObj.hostname !== void 0) {
      attributes.push({ key: "host.name", value: { stringValue: logObj.hostname } });
    }
    for (const [key, value] of Object.entries(logObj)) {
      if (!EXCLUDE_FIELDS.has(key)) {
        attributes.push({ key, value: convertValue(value) });
      }
    }
    return {
      timeUnixNano: String(BigInt(logObj.time) * BigInt(1e6)),
      observedTimeUnixNano: String(BigInt(Date.now()) * BigInt(1e6)),
      severityNumber,
      severityText,
      body: { stringValue: logObj.msg || "" },
      attributes,
      traceId: "",
      spanId: ""
    };
  }
  async flush() {
    if (this.flushTimer) {
      clearTimeout(this.flushTimer);
      this.flushTimer = null;
    }
    if (this.pendingLogs.length === 0) {
      return;
    }
    const logs = this.pendingLogs;
    this.pendingLogs = [];
    try {
      await this.sendLogs(logs);
    } catch (error) {
      this.pendingLogs = [...logs, ...this.pendingLogs];
      console.error("[PinoCloudExporter] Failed to flush logs:", error);
    }
  }
  async sendLogs(logRecords) {
    await this.ensureJwt();
    const payload = {
      resourceLogs: [
        {
          resource: {
            attributes: [
              { key: "service.name", value: { stringValue: "livekit-agents" } },
              { key: "room_id", value: { stringValue: this.config.roomId } },
              { key: "job_id", value: { stringValue: this.config.jobId } }
            ]
          },
          scopeLogs: [
            {
              scope: {
                name: this.loggerName,
                attributes: [
                  { key: "room_id", value: { stringValue: this.config.roomId } },
                  { key: "job_id", value: { stringValue: this.config.jobId } }
                ]
              },
              logRecords
            }
          ]
        }
      ]
    };
    const endpoint = `https://${this.config.cloudHostname}/observability/logs/otlp/v0`;
    const response = await fetch(endpoint, {
      method: "POST",
      headers: {
        Authorization: `Bearer ${this.jwt}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify(payload)
    });
    if (!response.ok) {
      const text = await response.text();
      throw new Error(`Log export failed: ${response.status} ${response.statusText} - ${text}`);
    }
  }
  async ensureJwt() {
    if (this.jwt) return;
    const apiKey = process.env.LIVEKIT_API_KEY;
    const apiSecret = process.env.LIVEKIT_API_SECRET;
    if (!apiKey || !apiSecret) {
      throw new Error("LIVEKIT_API_KEY and LIVEKIT_API_SECRET must be set");
    }
    const token = new import_livekit_server_sdk.AccessToken(apiKey, apiSecret, { ttl: "6h" });
    token.addObservabilityGrant({ write: true });
    this.jwt = await token.toJwt();
  }
  async shutdown() {
    await this.flush();
  }
}
let globalExporter = null;
function initPinoCloudExporter(config) {
  globalExporter = new PinoCloudExporter(config);
}
function getPinoCloudExporter() {
  return globalExporter;
}
function emitToOtel(logObj) {
  if (globalExporter) {
    globalExporter.emit(logObj);
  }
}
async function flushPinoLogs() {
  if (globalExporter) {
    await globalExporter.flush();
  }
}
// Annotate the CommonJS export names for ESM import in node:
0 && (module.exports = {
  PinoCloudExporter,
  emitToOtel,
  flushPinoLogs,
  getPinoCloudExporter,
  initPinoCloudExporter
});
//# sourceMappingURL=pino_otel_transport.cjs.map