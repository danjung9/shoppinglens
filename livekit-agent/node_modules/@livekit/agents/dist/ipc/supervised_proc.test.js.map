{"version":3,"sources":["../../src/ipc/supervised_proc.test.ts"],"sourcesContent":["// SPDX-FileCopyrightText: 2024 LiveKit, Inc.\n//\n// SPDX-License-Identifier: Apache-2.0\nimport { fork, spawn } from 'node:child_process';\nimport { unlinkSync, writeFileSync } from 'node:fs';\nimport { tmpdir } from 'node:os';\nimport { join } from 'node:path';\nimport pidusage from 'pidusage';\nimport { afterAll, beforeAll, describe, expect, it } from 'vitest';\n\nconst childScript = join(tmpdir(), 'test_child.mjs');\n\nbeforeAll(() => {\n  writeFileSync(\n    childScript,\n    `process.on('message', (msg) => process.send?.({ echo: msg }));\n     setInterval(() => {}, 1000);`,\n  );\n});\n\nafterAll(() => {\n  try {\n    unlinkSync(childScript);\n  } catch {}\n});\n\nasync function getChildMemoryUsageMB(pid: number | undefined): Promise<number> {\n  if (!pid) return 0;\n  try {\n    const stats = await pidusage(pid);\n    return stats.memory / (1024 * 1024);\n  } catch (err) {\n    const code = (err as NodeJS.ErrnoException).code;\n    if (code === 'ENOENT' || code === 'ESRCH') {\n      return 0;\n    }\n    throw err;\n  }\n}\n\ndescribe('pidusage on dead process', () => {\n  it('raw pidusage throws on dead pid', async () => {\n    const child = spawn('sleep', ['10']);\n    const pid = child.pid!;\n\n    child.kill('SIGKILL');\n    await new Promise<void>((r) => child.on('exit', r));\n\n    await expect(pidusage(pid)).rejects.toThrow();\n  });\n\n  it('fixed version returns 0 instead of crashing', async () => {\n    const child = spawn('sleep', ['10']);\n    const pid = child.pid!;\n\n    child.kill('SIGKILL');\n    await new Promise<void>((r) => child.on('exit', r));\n\n    const mem = await getChildMemoryUsageMB(pid);\n    expect(mem).toBe(0);\n  });\n\n  it('handles concurrent calls on dying process', async () => {\n    const child = spawn('sleep', ['10']);\n    const pid = child.pid!;\n    const exitPromise = new Promise<void>((r) => child.on('exit', r));\n\n    child.kill('SIGKILL');\n\n    const results = await Promise.all([\n      getChildMemoryUsageMB(pid),\n      getChildMemoryUsageMB(pid),\n      getChildMemoryUsageMB(pid),\n    ]);\n\n    await exitPromise;\n    expect(results.every((r) => r === 0)).toBe(true);\n  });\n});\n\ndescribe('IPC send on dead process', () => {\n  it('child.connected becomes false when child dies', async () => {\n    const child = fork(childScript, [], { stdio: ['pipe', 'pipe', 'pipe', 'ipc'] });\n    const exitPromise = new Promise<void>((r) => child.on('exit', r));\n\n    await new Promise((r) => setTimeout(r, 50));\n    expect(child.connected).toBe(true);\n\n    child.kill('SIGKILL');\n    await exitPromise;\n\n    expect(child.connected).toBe(false);\n  });\n\n  it('checking connected before send prevents crash', async () => {\n    const child = fork(childScript, [], { stdio: ['pipe', 'pipe', 'pipe', 'ipc'] });\n    const exitPromise = new Promise<void>((r) => child.on('exit', r));\n\n    // Suppress EPIPE errors that can occur due to race conditions between\n    // child.connected check and the actual pipe state\n    child.on('error', (err: NodeJS.ErrnoException) => {\n      if (err.code !== 'EPIPE') throw err;\n    });\n\n    let sent = 0;\n    let skipped = 0;\n\n    const interval = setInterval(() => {\n      if (child.connected) {\n        child.send({ ping: Date.now() });\n        sent++;\n      } else {\n        skipped++;\n      }\n    }, 20);\n\n    await new Promise((r) => setTimeout(r, 60));\n    child.kill('SIGKILL');\n    await exitPromise;\n    await new Promise((r) => setTimeout(r, 80));\n    clearInterval(interval);\n\n    expect(sent).toBeGreaterThan(0);\n    expect(skipped).toBeGreaterThan(0);\n  });\n});\n\ndescribe('timer cleanup', () => {\n  it('clearInterval stops the interval', async () => {\n    let count = 0;\n    const interval = setInterval(() => count++, 30);\n\n    await new Promise((r) => setTimeout(r, 80));\n    const countAtClear = count;\n    clearInterval(interval);\n\n    await new Promise((r) => setTimeout(r, 80));\n    expect(count).toBe(countAtClear);\n  });\n\n  it('double clear is safe', () => {\n    const interval = setInterval(() => {}, 100);\n    const timeout = setTimeout(() => {}, 1000);\n\n    clearInterval(interval);\n    clearTimeout(timeout);\n\n    expect(() => {\n      clearInterval(interval);\n      clearTimeout(timeout);\n    }).not.toThrow();\n  });\n});\n"],"mappings":"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","names":[]}