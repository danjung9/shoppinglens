{"version":3,"sources":["../../src/telemetry/utils.ts"],"sourcesContent":["// SPDX-FileCopyrightText: 2025 LiveKit, Inc.\n//\n// SPDX-License-Identifier: Apache-2.0\nimport { type Span, SpanStatusCode, context as otelContext, trace } from '@opentelemetry/api';\nimport type { RealtimeModelMetrics } from '../metrics/base.js';\nimport * as traceTypes from './trace_types.js';\nimport { tracer } from './traces.js';\n\nexport function recordException(span: Span, error: Error): void {\n  span.recordException(error);\n  span.setStatus({\n    code: SpanStatusCode.ERROR,\n    message: error.message,\n  });\n\n  // Set exception attributes for better visibility\n  // (in case the exception event is not rendered by the backend)\n  span.setAttributes({\n    [traceTypes.ATTR_EXCEPTION_TYPE]: error.constructor.name,\n    [traceTypes.ATTR_EXCEPTION_MESSAGE]: error.message,\n    [traceTypes.ATTR_EXCEPTION_TRACE]: error.stack || '',\n  });\n}\n\nexport function recordRealtimeMetrics(span: Span, metrics: RealtimeModelMetrics): void {\n  const attrs: Record<string, string | number> = {\n    [traceTypes.ATTR_GEN_AI_REQUEST_MODEL]: metrics.label || 'unknown',\n    [traceTypes.ATTR_REALTIME_MODEL_METRICS]: JSON.stringify(metrics),\n    [traceTypes.ATTR_GEN_AI_USAGE_INPUT_TOKENS]: metrics.inputTokens,\n    [traceTypes.ATTR_GEN_AI_USAGE_OUTPUT_TOKENS]: metrics.outputTokens,\n    [traceTypes.ATTR_GEN_AI_USAGE_INPUT_TEXT_TOKENS]: metrics.inputTokenDetails.textTokens,\n    [traceTypes.ATTR_GEN_AI_USAGE_INPUT_AUDIO_TOKENS]: metrics.inputTokenDetails.audioTokens,\n    [traceTypes.ATTR_GEN_AI_USAGE_INPUT_CACHED_TOKENS]: metrics.inputTokenDetails.cachedTokens,\n    [traceTypes.ATTR_GEN_AI_USAGE_OUTPUT_TEXT_TOKENS]: metrics.outputTokenDetails.textTokens,\n    [traceTypes.ATTR_GEN_AI_USAGE_OUTPUT_AUDIO_TOKENS]: metrics.outputTokenDetails.audioTokens,\n  };\n\n  // Add LangFuse-specific completion start time if TTFT is available\n  if (metrics.ttftMs !== undefined && metrics.ttftMs !== -1) {\n    const completionStartTime = metrics.timestamp + metrics.ttftMs;\n    // Convert to UTC ISO string for LangFuse compatibility\n    const completionStartTimeUtc = new Date(completionStartTime).toISOString();\n    attrs[traceTypes.ATTR_LANGFUSE_COMPLETION_START_TIME] = completionStartTimeUtc;\n  }\n\n  if (span.isRecording()) {\n    span.setAttributes(attrs);\n  } else {\n    const currentContext = otelContext.active();\n    const spanContext = trace.setSpan(currentContext, span);\n\n    // Create a dedicated child span for orphaned metrics\n    tracer.getTracer().startActiveSpan('realtime_metrics', {}, spanContext, (child) => {\n      try {\n        child.setAttributes(attrs);\n      } finally {\n        child.end();\n      }\n    });\n  }\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAGA,iBAAyE;AAEzE,iBAA4B;AAC5B,oBAAuB;AAEhB,SAAS,gBAAgB,MAAY,OAAoB;AAC9D,OAAK,gBAAgB,KAAK;AAC1B,OAAK,UAAU;AAAA,IACb,MAAM,0BAAe;AAAA,IACrB,SAAS,MAAM;AAAA,EACjB,CAAC;AAID,OAAK,cAAc;AAAA,IACjB,CAAC,WAAW,mBAAmB,GAAG,MAAM,YAAY;AAAA,IACpD,CAAC,WAAW,sBAAsB,GAAG,MAAM;AAAA,IAC3C,CAAC,WAAW,oBAAoB,GAAG,MAAM,SAAS;AAAA,EACpD,CAAC;AACH;AAEO,SAAS,sBAAsB,MAAY,SAAqC;AACrF,QAAM,QAAyC;AAAA,IAC7C,CAAC,WAAW,yBAAyB,GAAG,QAAQ,SAAS;AAAA,IACzD,CAAC,WAAW,2BAA2B,GAAG,KAAK,UAAU,OAAO;AAAA,IAChE,CAAC,WAAW,8BAA8B,GAAG,QAAQ;AAAA,IACrD,CAAC,WAAW,+BAA+B,GAAG,QAAQ;AAAA,IACtD,CAAC,WAAW,mCAAmC,GAAG,QAAQ,kBAAkB;AAAA,IAC5E,CAAC,WAAW,oCAAoC,GAAG,QAAQ,kBAAkB;AAAA,IAC7E,CAAC,WAAW,qCAAqC,GAAG,QAAQ,kBAAkB;AAAA,IAC9E,CAAC,WAAW,oCAAoC,GAAG,QAAQ,mBAAmB;AAAA,IAC9E,CAAC,WAAW,qCAAqC,GAAG,QAAQ,mBAAmB;AAAA,EACjF;AAGA,MAAI,QAAQ,WAAW,UAAa,QAAQ,WAAW,IAAI;AACzD,UAAM,sBAAsB,QAAQ,YAAY,QAAQ;AAExD,UAAM,yBAAyB,IAAI,KAAK,mBAAmB,EAAE,YAAY;AACzE,UAAM,WAAW,mCAAmC,IAAI;AAAA,EAC1D;AAEA,MAAI,KAAK,YAAY,GAAG;AACtB,SAAK,cAAc,KAAK;AAAA,EAC1B,OAAO;AACL,UAAM,iBAAiB,WAAAA,QAAY,OAAO;AAC1C,UAAM,cAAc,iBAAM,QAAQ,gBAAgB,IAAI;AAGtD,yBAAO,UAAU,EAAE,gBAAgB,oBAAoB,CAAC,GAAG,aAAa,CAAC,UAAU;AACjF,UAAI;AACF,cAAM,cAAc,KAAK;AAAA,MAC3B,UAAE;AACA,cAAM,IAAI;AAAA,MACZ;AAAA,IACF,CAAC;AAAA,EACH;AACF;","names":["otelContext"]}