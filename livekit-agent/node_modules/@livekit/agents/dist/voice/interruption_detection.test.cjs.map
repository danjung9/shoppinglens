{"version":3,"sources":["../../src/voice/interruption_detection.test.ts"],"sourcesContent":["// SPDX-FileCopyrightText: 2025 LiveKit, Inc.\n//\n// SPDX-License-Identifier: Apache-2.0\n\n/**\n * Unit tests for interruption detection logic in AgentActivity.\n *\n * Tests the refactored minInterruptionWords check which ensures:\n * - Consistent word count filtering across all speech scenarios\n * - Proper handling of empty strings, undefined, and short speech\n * - Interruptions allowed only when word count meets or exceeds minInterruptionWords threshold\n */\nimport { describe, expect, it } from 'vitest';\nimport { splitWords } from '../tokenize/basic/word.js';\n\ndescribe('Interruption Detection - Word Counting', () => {\n  describe('Word Splitting Behavior', () => {\n    it('should count empty string as 0 words', () => {\n      const text = '';\n      const wordCount = splitWords(text, true).length;\n      expect(wordCount).toBe(0);\n    });\n\n    it('should count single word correctly', () => {\n      const text = 'hello';\n      const wordCount = splitWords(text, true).length;\n      expect(wordCount).toBe(1);\n    });\n\n    it('should count two words correctly', () => {\n      const text = 'hello world';\n      const wordCount = splitWords(text, true).length;\n      expect(wordCount).toBe(2);\n    });\n\n    it('should count multiple words correctly', () => {\n      const text = 'hello this is a full sentence';\n      const wordCount = splitWords(text, true).length;\n      expect(wordCount).toBe(6);\n    });\n\n    it('should handle punctuation correctly', () => {\n      const text = 'hello, world!';\n      const wordCount = splitWords(text, true).length;\n      expect(wordCount).toBe(2);\n    });\n\n    it('should handle multiple spaces between words', () => {\n      const text = 'hello  world';\n      const wordCount = splitWords(text, true).length;\n      expect(wordCount).toBe(2);\n    });\n\n    it('should count whitespace-only string as 0 words', () => {\n      const text = '   ';\n      const wordCount = splitWords(text, true).length;\n      expect(wordCount).toBe(0);\n    });\n\n    it('should handle leading and trailing whitespace', () => {\n      const text = '  hello world  ';\n      const wordCount = splitWords(text, true).length;\n      expect(wordCount).toBe(2);\n    });\n  });\n\n  describe('Integration: Full Interruption Check Logic', () => {\n    it('should block interruption for empty transcript with threshold 2', () => {\n      const text = '';\n      const minInterruptionWords = 2;\n\n      const normalizedText = text ?? '';\n      const wordCount = splitWords(normalizedText, true).length;\n      const shouldBlock = wordCount < minInterruptionWords;\n\n      expect(normalizedText).toBe('');\n      expect(wordCount).toBe(0);\n      expect(shouldBlock).toBe(true);\n    });\n\n    it('should block interruption for undefined transcript with threshold 2', () => {\n      const text: string | undefined = undefined;\n      const minInterruptionWords = 2;\n\n      const normalizedText = text ?? '';\n      const wordCount = splitWords(normalizedText, true).length;\n      const shouldBlock = wordCount < minInterruptionWords;\n\n      expect(normalizedText).toBe('');\n      expect(wordCount).toBe(0);\n      expect(shouldBlock).toBe(true);\n    });\n\n    it('should block interruption for single word with threshold 2', () => {\n      const text = 'hello';\n      const minInterruptionWords = 2;\n\n      const normalizedText = text ?? '';\n      const wordCount = splitWords(normalizedText, true).length;\n      const shouldBlock = wordCount < minInterruptionWords;\n\n      expect(normalizedText).toBe('hello');\n      expect(wordCount).toBe(1);\n      expect(shouldBlock).toBe(true);\n    });\n\n    it('should allow interruption when word count exactly meets threshold', () => {\n      const text = 'hello world';\n      const minInterruptionWords = 2;\n\n      const normalizedText = text ?? '';\n      const wordCount = splitWords(normalizedText, true).length;\n      const shouldBlock = wordCount < minInterruptionWords;\n\n      expect(normalizedText).toBe('hello world');\n      expect(wordCount).toBe(2);\n      expect(shouldBlock).toBe(false);\n    });\n\n    it('should allow interruption when word count exceeds threshold', () => {\n      const text = 'hello this is a full sentence';\n      const minInterruptionWords = 2;\n\n      const normalizedText = text ?? '';\n      const wordCount = splitWords(normalizedText, true).length;\n      const shouldBlock = wordCount < minInterruptionWords;\n\n      expect(normalizedText).toBe('hello this is a full sentence');\n      expect(wordCount).toBe(6);\n      expect(shouldBlock).toBe(false);\n    });\n\n    it('should apply consistent word counting logic in both methods', () => {\n      const transcripts = ['', 'hello', 'hello world', 'this is a longer sentence'];\n      const threshold = 2;\n\n      transcripts.forEach((transcript) => {\n        const text1 = transcript;\n        const normalizedText1 = text1 ?? '';\n        const wordCount1 = splitWords(normalizedText1, true).length;\n        const shouldBlock1 = wordCount1 < threshold;\n\n        const wordCount2 = splitWords(transcript, true).length;\n        const shouldBlock2 = wordCount2 < threshold;\n\n        expect(wordCount1).toBe(wordCount2);\n        expect(shouldBlock1).toBe(shouldBlock2);\n      });\n    });\n  });\n});\n"],"mappings":"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","names":[]}