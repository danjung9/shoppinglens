{"version":3,"sources":["../../src/telemetry/pino_otel_transport.ts"],"sourcesContent":["// SPDX-FileCopyrightText: 2025 LiveKit, Inc.\n//\n// SPDX-License-Identifier: Apache-2.0\n\n/**\n * Custom Pino OTEL Transport\n *\n * Standalone exporter for Pino logs to LiveKit Cloud.\n * Uses raw HTTP JSON format, bypassing the OTEL SDK.\n */\nimport { SeverityNumber } from '@opentelemetry/api-logs';\nimport { AccessToken } from 'livekit-server-sdk';\n\nexport interface PinoLogObject {\n  level: number;\n  time: number;\n  msg: string;\n  pid?: number;\n  hostname?: string;\n  [key: string]: unknown;\n}\n\nexport interface PinoCloudExporterConfig {\n  cloudHostname: string;\n  roomId: string;\n  jobId: string;\n  loggerName?: string;\n  batchSize?: number;\n  flushIntervalMs?: number;\n}\n\nfunction mapPinoLevelToSeverity(pinoLevel: number): {\n  severityNumber: SeverityNumber;\n  severityText: string;\n} {\n  if (pinoLevel <= 10) {\n    return { severityNumber: SeverityNumber.TRACE, severityText: 'TRACE' };\n  } else if (pinoLevel <= 20) {\n    return { severityNumber: SeverityNumber.DEBUG, severityText: 'DEBUG' };\n  } else if (pinoLevel <= 30) {\n    return { severityNumber: SeverityNumber.INFO, severityText: 'INFO' };\n  } else if (pinoLevel <= 40) {\n    return { severityNumber: SeverityNumber.WARN, severityText: 'WARN' };\n  } else if (pinoLevel <= 50) {\n    return { severityNumber: SeverityNumber.ERROR, severityText: 'ERROR' };\n  } else {\n    return { severityNumber: SeverityNumber.FATAL, severityText: 'FATAL' };\n  }\n}\n\nconst EXCLUDE_FIELDS = new Set(['level', 'time', 'msg', 'pid', 'hostname', 'v']);\n\nfunction convertValue(value: unknown): unknown {\n  if (value === null || value === undefined) {\n    return { stringValue: '' };\n  }\n  if (typeof value === 'string') {\n    return { stringValue: value };\n  }\n  if (typeof value === 'number') {\n    return Number.isInteger(value) ? { intValue: String(value) } : { doubleValue: value };\n  }\n  if (typeof value === 'boolean') {\n    return { boolValue: value };\n  }\n  if (typeof value === 'object') {\n    return { stringValue: JSON.stringify(value) };\n  }\n  return { stringValue: String(value) };\n}\n\n/**\n * Standalone Pino log exporter for LiveKit Cloud.\n *\n * Collects Pino logs, batches them, and sends via raw HTTP JSON.\n * No OTEL SDK dependency\n *\n * @example\n * ```typescript\n * const exporter = new PinoCloudExporter({\n *   cloudHostname: 'cloud.livekit.io',\n *   roomId: 'RM_xxx',\n *   jobId: 'AJ_xxx',\n * });\n *\n * // In Pino formatter hook:\n * exporter.emit(logObj);\n *\n * // On session end:\n * await exporter.flush();\n * ```\n */\nexport class PinoCloudExporter {\n  private readonly config: PinoCloudExporterConfig;\n  private readonly loggerName: string;\n  private readonly batchSize: number;\n  private readonly flushIntervalMs: number;\n  private jwt: string | null = null;\n  private pendingLogs: any[] = [];\n  private flushTimer: NodeJS.Timeout | null = null;\n\n  constructor(config: PinoCloudExporterConfig) {\n    this.config = config;\n    this.loggerName = config.loggerName || 'livekit.agents';\n    this.batchSize = config.batchSize || 100;\n    this.flushIntervalMs = config.flushIntervalMs || 5000;\n  }\n\n  emit(logObj: PinoLogObject): void {\n    const record = this.convertToOtlpRecord(logObj);\n    this.pendingLogs.push(record);\n\n    if (!this.flushTimer) {\n      this.flushTimer = setTimeout(() => {\n        this.flush().catch(console.error);\n      }, this.flushIntervalMs);\n    }\n\n    if (this.pendingLogs.length >= this.batchSize) {\n      this.flush().catch(console.error);\n    }\n  }\n\n  private convertToOtlpRecord(logObj: PinoLogObject): any {\n    const { severityNumber, severityText } = mapPinoLevelToSeverity(logObj.level);\n\n    const attributes: any[] = [\n      { key: 'room_id', value: { stringValue: this.config.roomId } },\n      { key: 'job_id', value: { stringValue: this.config.jobId } },\n      { key: 'logger.name', value: { stringValue: this.loggerName } },\n    ];\n\n    if (logObj.pid !== undefined) {\n      attributes.push({ key: 'process.pid', value: { intValue: String(logObj.pid) } });\n    }\n    if (logObj.hostname !== undefined) {\n      attributes.push({ key: 'host.name', value: { stringValue: logObj.hostname } });\n    }\n\n    for (const [key, value] of Object.entries(logObj)) {\n      if (!EXCLUDE_FIELDS.has(key)) {\n        attributes.push({ key, value: convertValue(value) });\n      }\n    }\n\n    return {\n      timeUnixNano: String(BigInt(logObj.time) * BigInt(1_000_000)),\n      observedTimeUnixNano: String(BigInt(Date.now()) * BigInt(1_000_000)),\n      severityNumber,\n      severityText,\n      body: { stringValue: logObj.msg || '' },\n      attributes,\n      traceId: '',\n      spanId: '',\n    };\n  }\n\n  async flush(): Promise<void> {\n    if (this.flushTimer) {\n      clearTimeout(this.flushTimer);\n      this.flushTimer = null;\n    }\n\n    if (this.pendingLogs.length === 0) {\n      return;\n    }\n\n    const logs = this.pendingLogs;\n    this.pendingLogs = [];\n\n    try {\n      await this.sendLogs(logs);\n    } catch (error) {\n      this.pendingLogs = [...logs, ...this.pendingLogs];\n      console.error('[PinoCloudExporter] Failed to flush logs:', error);\n    }\n  }\n\n  private async sendLogs(logRecords: any[]): Promise<void> {\n    await this.ensureJwt();\n\n    const payload = {\n      resourceLogs: [\n        {\n          resource: {\n            attributes: [\n              { key: 'service.name', value: { stringValue: 'livekit-agents' } },\n              { key: 'room_id', value: { stringValue: this.config.roomId } },\n              { key: 'job_id', value: { stringValue: this.config.jobId } },\n            ],\n          },\n          scopeLogs: [\n            {\n              scope: {\n                name: this.loggerName,\n                attributes: [\n                  { key: 'room_id', value: { stringValue: this.config.roomId } },\n                  { key: 'job_id', value: { stringValue: this.config.jobId } },\n                ],\n              },\n              logRecords,\n            },\n          ],\n        },\n      ],\n    };\n\n    const endpoint = `https://${this.config.cloudHostname}/observability/logs/otlp/v0`;\n\n    const response = await fetch(endpoint, {\n      method: 'POST',\n      headers: {\n        Authorization: `Bearer ${this.jwt}`,\n        'Content-Type': 'application/json',\n      },\n      body: JSON.stringify(payload),\n    });\n\n    if (!response.ok) {\n      const text = await response.text();\n      throw new Error(`Log export failed: ${response.status} ${response.statusText} - ${text}`);\n    }\n  }\n\n  private async ensureJwt(): Promise<void> {\n    if (this.jwt) return;\n\n    const apiKey = process.env.LIVEKIT_API_KEY;\n    const apiSecret = process.env.LIVEKIT_API_SECRET;\n\n    if (!apiKey || !apiSecret) {\n      throw new Error('LIVEKIT_API_KEY and LIVEKIT_API_SECRET must be set');\n    }\n\n    const token = new AccessToken(apiKey, apiSecret, { ttl: '6h' });\n    token.addObservabilityGrant({ write: true });\n    this.jwt = await token.toJwt();\n  }\n\n  async shutdown(): Promise<void> {\n    await this.flush();\n  }\n}\n\nlet globalExporter: PinoCloudExporter | null = null;\n\nexport function initPinoCloudExporter(config: PinoCloudExporterConfig): void {\n  globalExporter = new PinoCloudExporter(config);\n}\n\nexport function getPinoCloudExporter(): PinoCloudExporter | null {\n  return globalExporter;\n}\n\nexport function emitToOtel(logObj: PinoLogObject): void {\n  if (globalExporter) {\n    globalExporter.emit(logObj);\n  }\n}\n\nexport async function flushPinoLogs(): Promise<void> {\n  if (globalExporter) {\n    await globalExporter.flush();\n  }\n}\n"],"mappings":"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","names":[]}